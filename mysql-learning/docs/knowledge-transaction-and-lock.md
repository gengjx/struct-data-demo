# 事务与锁必须掌握知识点（对应 questions-transaction-and-lock）

## 1. 事务与隔离级别

### 概念

- ACID：原子性、一致性、隔离性、持久性。
- MySQL 8 InnoDB 默认隔离级别：RR（可重复读）。

### 必会要点

- RU/RC/RR/Serializable 的差异
- 常见现象：脏读、不可重复读、幻读

### 对应题目

- 题 1

## 2. 锁的基本类型（InnoDB）

### 概念

- 行锁是建立在索引之上的：更新/锁定如果无法命中索引，可能扩大锁范围。

### 必会要点

- `SELECT ... FOR UPDATE`（排他锁）
- `LOCK IN SHARE MODE`（共享锁）
- RR 下可能出现：记录锁/间隙锁/临键锁（next-key lock）

### 对应题目

- 题 3

## 3. 并发一致性：扣库存

### 常见方案

- 悲观锁：
  - `SELECT ... FOR UPDATE` 锁住库存行
  - `UPDATE ... SET available = available - ? WHERE available >= ?`
- 乐观锁：
  - 增加 `version` 字段，`UPDATE ... WHERE version=?`

### 常见坑

- 只 `SELECT` 不加锁，然后再 `UPDATE`，并发下会超卖。
- 事务太长导致锁等待、吞吐下降。

### 对应题目

- 题 2

## 4. 死锁

### 概念

- 两个事务相互等待对方释放锁，形成环路。

### 典型成因

- 不同事务以不同顺序更新多行/多表。

### 避免策略

- 统一访问顺序
- 缩短事务
- 保证命中索引减少锁范围

### 对应题目

- 题 4

## 5. 长事务风险与治理

### 常见风险

- 占用锁时间长，造成大量锁等待
- undo/历史版本膨胀，影响 purge
- 复制延迟/回放压力增大

### 治理思路

- 业务拆分事务边界
- 控制批量更新规模
- 监控并告警长事务

### 对应题目

- 题 5
